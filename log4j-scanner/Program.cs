//create regex for jndi string
using System.Text.RegularExpressions;

var jndiRegex = @"\$(\{|%7B)jndi:(ldap[s]?|rmi|dns|nis|iiop|corba|nds|http):/[^\n]+";
var obfuscated_regex = @"/(?:\$|\%24)(?:\{|\%7b)[^\w]*?j[^\w]*?n[^\w]*?d[^\w]*?i[^\w]*?(?:\:|\%3a)/i";

//ask user if linux or windows , accept 1 for linux and 2 for windows
Console.WriteLine("Is this a linux or windows machine? (1 for linux, 2 for windows)");
var os = Console.ReadLine();
//verify user input
if (os != "1" && os != "2")
{
    Console.WriteLine("Invalid input");
    Environment.Exit(1);
}
//if linux
if (os == "1")
{
    //array with all common log directories
    var log_path = "/var/log/";
    //get all files in log directory and subdirectories
    var files = Directory.GetFiles(log_path, "*", SearchOption.AllDirectories);
    //check each file for regex match on both regex patterns, if match found, print path,file name, line number and match
    var count = 0;
    foreach (var file in files)
    {
        var lines = File.ReadAllLines(file);
        foreach (var line in lines)
        {
            if (Regex.IsMatch(line, jndiRegex) || Regex.IsMatch(line, obfuscated_regex))
            {
                Console.WriteLine("{0}:{1}:{2}", file, line, line.Substring(line.IndexOf(jndiRegex)));
                count++;
            }
        }
    }
    // print out total number of matches, if any
    Console.WriteLine("Total matches: {0}", count);
    //wait for input , exit
    Console.ReadLine();
    Environment.Exit(0);
}
//if windows
if (os == "2")
{
    //path for windows system logs
    var log_path = "C:\\Windows\\System32\\config\\";
    //path for iis logs
    var iis_log_path = "C:\\inetpub\\logs\\";
    //get all files from both directories, and subdirectories
    var files = Directory.GetFiles(log_path, "*", SearchOption.AllDirectories);
    var iis_files = Directory.GetFiles(iis_log_path, "*", SearchOption.AllDirectories);
    //combine both arrays
    var all_files = files.Concat(iis_files);
    //check each file for regex match on both regex patterns, if match found, print path,file name, line number and match
    var count = 0;
    foreach (var file in all_files)
    {
        var lines = File.ReadAllLines(file);
        foreach (var line in lines)
        {
            if (Regex.IsMatch(line, jndiRegex) || Regex.IsMatch(line, obfuscated_regex))
            {
                Console.WriteLine("{0}:{1}:{2}", file, line, line.Substring(line.IndexOf(jndiRegex)));
                count++;
            }
        }
    }
    // print out total number of matches, if any
    Console.WriteLine("Total matches: {0}", count);
    //wait for input , exit
    Console.ReadLine();
    Environment.Exit(0);
}